<!-- templates/settings.html -->
{% extends "_layout.html" %}
{% block title %}ç³»çµ±è¨­å®š{% endblock %}

{% block content %}
<h1 class="mb-4 fw-bold">âš™ï¸ ç³»çµ±è¨­å®š</h1>

<!-- ä½¿ç”¨è€…ç®¡ç†ï¼šäº’å‹•å€å¡Šï¼ˆæ–°å¢/ä¿®æ”¹è§’è‰²ã€å•Ÿç”¨ã€é‡è¨­å¯†ç¢¼ã€åˆªé™¤ï¼‰ -->
{% if role == 'technician' %}
<div class="card mb-4 shadow-sm">
  <div class="card-header bg-light fw-bold">ğŸ”§ ä½¿ç”¨è€…ç®¡ç†ï¼ˆäº’å‹•ï¼‰</div>
  <div class="card-body">
    <form id="um-add" class="row g-2 align-items-end mb-3">
      <div class="col-md-3">
        <label class="form-label">å¸³è™Ÿ</label>
        <input class="form-control" name="username" required>
      </div>
      <div class="col-md-3">
        <label class="form-label">å¯†ç¢¼</label>
        <input class="form-control" name="password" type="password" required>
      </div>
      <div class="col-md-3">
        <label class="form-label">è§’è‰²</label>
        <select class="form-select" name="role">
          <option value="technician" selected>technician</option>
          <option value="user">user</option>
        </select>
      </div>
      <div class="col-md-3 d-grid">
        <button class="btn btn-primary">â• æ–°å¢</button>
      </div>
      <div id="um-add-msg" class="form-text text-danger"></div>
    </form>

    <div class="table-responsive">
      <table class="table table-bordered table-sm align-middle" id="um-table">
        <thead class="table-light">
          <tr>
            <th>å¸³è™Ÿ</th>
            <th>è§’è‰²</th>
            <th>å•Ÿç”¨</th>
            <th style="width:260px;">å‹•ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
(() => {
  if ('{{ role }}' !== 'technician') return;

  const $ = (q, root=document) => root.querySelector(q);
  const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));

  const apiList = '{{ url_for("settings.api_users_list") if "settings.api_users_list" in g|default({}) else "/settings/api/users" }}';
  const apiBase = '/settings/api/users'; // å¾Œå‚™ï¼ˆå³ä½¿ä¸Šé¢å–ä¸åˆ° url_for ä¹Ÿèƒ½ç”¨ï¼‰

  async function listUsers() {
    const res = await fetch(apiList);
    const j = await res.json();
    if (!j.ok) { alert('è®€å–ä½¿ç”¨è€…å¤±æ•—'); return []; }
    return j.users || [];
  }

  function render(users) {
    const tb = $('#um-table tbody');
    tb.innerHTML = '';
    users.forEach(u => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${u.username}</td>
        <td>
          <select class="form-select form-select-sm um-role">
            <option value="technician" ${u.role==='technician'?'selected':''}>technician</option>
            <option value="user" ${u.role==='user'?'selected':''}>user</option>
          </select>
        </td>
        <td>
          <select class="form-select form-select-sm um-active">
            <option value="true" ${u.active?'selected':''}>true</option>
            <option value="false" ${!u.active?'selected':''}>false</option>
          </select>
        </td>
        <td>
          <div class="d-flex gap-2">
            <button class="btn btn-success btn-sm um-save">å„²å­˜</button>
            <button class="btn btn-warning btn-sm um-reset">é‡è¨­å¯†ç¢¼</button>
            <button class="btn btn-danger btn-sm um-del">åˆªé™¤</button>
          </div>
        </td>
      `;
      tr.dataset.username = u.username;
      tb.appendChild(tr);
    });
  }

  async function refresh() { render(await listUsers()); }

  // æ–°å¢
  const addForm = $('#um-add');
  addForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(addForm);
    const payload = {
      username: fd.get('username'),
      password: fd.get('password'),
      role: fd.get('role')
    };
    const res = await fetch(apiBase, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const msg = $('#um-add-msg');
    msg.textContent = '';
    const j = await res.json().catch(()=>({}));
    if (!res.ok || !j.ok) {
      msg.textContent = (j && j.error) ? j.error : 'æ–°å¢å¤±æ•—';
      return;
    }
    addForm.reset();
    await refresh();
  });

  // è¡¨æ ¼äº‹ä»¶ï¼šå„²å­˜ / é‡è¨­å¯†ç¢¼ / åˆªé™¤
  $('#um-table')?.addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const tr = btn.closest('tr');
    const username = tr?.dataset.username;
    if (!username) return;

    if (btn.classList.contains('um-save')) {
      const role = tr.querySelector('.um-role').value;
      const active = tr.querySelector('.um-active').value === 'true';
      const res = await fetch(`${apiBase}/${encodeURIComponent(username)}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ role, active })
      });
      const j = await res.json().catch(()=>({}));
      if (!res.ok || !j.ok) return alert(j.error || 'å„²å­˜å¤±æ•—');
      await refresh();
    }

    if (btn.classList.contains('um-reset')) {
      const pwd = prompt('è¼¸å…¥æ–°å¯†ç¢¼ï¼š');
      if (!pwd) return;
      const res = await fetch(`${apiBase}/${encodeURIComponent(username)}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: pwd })
      });
      const j = await res.json().catch(()=>({}));
      if (!res.ok || !j.ok) return alert(j.error || 'é‡è¨­å¤±æ•—');
      alert('å·²æ›´æ–°å¯†ç¢¼');
    }

    if (btn.classList.contains('um-del')) {
      if (!confirm(`ç¢ºå®šåˆªé™¤ ${username}ï¼Ÿ`)) return;
      const res = await fetch(`${apiBase}/${encodeURIComponent(username)}`, { method: 'DELETE' });
      const j = await res.json().catch(()=>({}));
      if (!res.ok || !j.ok) return alert(j.error || 'åˆªé™¤å¤±æ•—');
      await refresh();
    }
  });

  // åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', refresh);
})();
</script>

{% endif %}

<!-- è‰ç¨¿ç®¡ç† -->
<div class="card mb-4 shadow-sm">
  <div class="card-header bg-light fw-bold">ğŸ“‹ è‰ç¨¿ç®¡ç†</div>
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <input id="draft-search" class="form-control" style="max-width:280px;" placeholder="æœå°‹æ¨™é¡Œæˆ–æ‘˜è¦â€¦">
      <div class="text-muted small">åªé¡¯ç¤ºç›®å‰ç™»å…¥è€…çš„è‰ç¨¿</div>
    </div>
    <div class="table-responsive">
      <table class="table table-bordered table-sm align-middle" id="drafts-table">
        <thead class="table-light">
          <tr>
            <th style="width:40%;">æ¨™é¡Œ</th>
            <th style="width:25%;">æœ€å¾Œæ›´æ–°</th>
            <th>æ‘˜è¦</th>
            <th style="width:180px;">å‹•ä½œ</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="4" class="text-center text-muted">è¼‰å…¥ä¸­â€¦</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
(() => {
  const $ = (q, root=document) => root.querySelector(q);
  const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));

  const apiList = '{{ url_for("settings.api_drafts_list") }}';
  const apiDeleteBase = '{{ url_for("settings.api_draft_delete", draft_id="__D__") }}';

  function fmtTime(ts) {
    try {
      const t = (typeof ts === 'number') ? ts*1000 : (String(ts).length === 13 ? Number(ts) : Number(ts)*1000);
      return new Date(t).toLocaleString();
    } catch { return String(ts || ''); }
  }

  async function loadDrafts() {
    const r = await fetch(apiList);
    const j = await r.json().catch(()=>({}));
    if (!j || !j.ok) return [];
    return j.drafts || [];
  }

  function renderDrafts(drafts) {
    const q = $('#draft-search').value.trim().toLowerCase();
    const tb = $('#drafts-table tbody');
    tb.innerHTML = '';

    const filtered = drafts.filter(d => {
      const t = (d.title || '').toLowerCase();
      const s = (d.summary || '').toLowerCase();
      return !q || t.includes(q) || s.includes(q);
    });

    if (!filtered.length) {
      tb.innerHTML = `<tr><td colspan="4" class="text-center text-muted">æ²’æœ‰è‰ç¨¿</td></tr>`;
      return;
    }

    filtered.forEach(d => {
      const tr = document.createElement('tr');
      tr.dataset.id = d.id;
      tr.innerHTML = `
        <td>${d.title || '(æœªå‘½åè‰ç¨¿)'}</td>
        <td>${fmtTime(d.updated_at)}</td>
        <td class="text-truncate" style="max-width:420px;">${d.summary || ''}</td>
        <td>
          <div class="d-flex gap-2">
            <a class="btn btn-sm btn-primary"href="{{ url_for('new_page') }}?draft_id=${encodeURIComponent(d.id)}">ç·¨è¼¯</a>
            <button class="btn btn-sm btn-danger btn-draft-del">åˆªé™¤</button>
          </div>
        </td>
      `;
      tb.appendChild(tr);
    });
  }

  async function refreshDrafts() {
    const drafts = await loadDrafts();
    window.__drafts_cache = drafts;
    renderDrafts(drafts);
  }

  // æœå°‹
  $('#draft-search')?.addEventListener('input', () => {
    renderDrafts(window.__drafts_cache || []);
  });

  // åˆªé™¤
  $('#drafts-table')?.addEventListener('click', async (e) => {
    const btn = e.target.closest('.btn-draft-del');
    if (!btn) return;
    const tr = btn.closest('tr');
    const id = tr?.dataset.id;
    if (!id) return;

    if (!confirm('ç¢ºå®šåˆªé™¤é€™å€‹è‰ç¨¿ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;

    const url = apiDeleteBase.replace('__D__', encodeURIComponent(id));
    const r = await fetch(url, { method: 'DELETE' });
    const j = await r.json().catch(()=>({}));
    if (!j || !j.ok) {
      alert(j.error || 'åˆªé™¤å¤±æ•—');
      return;
    }
    await refreshDrafts();
  });

  // åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', refreshDrafts);
})();
</script>

  <!-- å¤–è§€èˆ‡æ’åºåå¥½ -->
  <!--
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-light fw-bold">ğŸŒˆ å¤–è§€èˆ‡æ’åºåå¥½</div>
    <div class="card-body">
      <form id="preferences-form">
        <div class="mb-3">
          <label class="form-label">ğŸŒ™ ä¸»é¡Œæ¨¡å¼ï¼š</label>
          <select name="theme" class="form-select">
            <option value="light">â˜€ï¸ æ·ºè‰²</option>
            <option value="dark">ğŸŒ™ æ·±è‰²</option>
          </select>
        </div>

        <button class="btn btn-outline-success">ğŸ’¾ å„²å­˜åå¥½</button>
        <span id="pref-msg" class="ms-2 text-success" style="display:none;">å·²å„²å­˜</span>
      </form>
    </div>
  </div>
  -->
  

<script>
// åå¥½è¨­å®šï¼šç”¨ url_for ç”¢ç”Ÿæ­£ç¢ºè·¯å¾‘
document.querySelector('#preferences-form').addEventListener('submit', async function(e) {
  e.preventDefault();

  const data = {
    theme: this.theme.value,
    default_sort: this.default_sort.value,
    show_categories: this.show_categories.checked
  };

  const res = await fetch('{{ url_for("settings.save_preferences") }}', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });
  const j = await res.json().catch(() => ({}));
  if (j && j.success) {
    const ok = document.getElementById('pref-msg');
    ok.style.display = 'inline';
    setTimeout(() => ok.style.display = 'none', 1500);
  } else {
    alert('å„²å­˜å¤±æ•—');
  }
});

// æ–°å¢ä½¿ç”¨è€…ï¼šä¸²åˆ° /settings/users/add
const addForm = document.getElementById('add-user-form');
if (addForm) {
  addForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(addForm);
    const msg = document.getElementById('add-user-msg');
    msg.textContent = '';

    const res = await fetch('{{ url_for("settings.add_user") }}', {
      method: 'POST',
      body: fd
    });

    if (res.ok) {
      const j = await res.json();
      if (j.ok) {
        // é‡æ–°æ•´ç†ä»¥æ›´æ–°ä¸Šæ–¹æ¸…å–®ï¼ˆç°¡å–®åšæ³•ï¼‰
        location.reload();
        return;
      }
    }
    const j = await res.json().catch(() => ({}));
    msg.textContent = (j && j.error) ? j.error : 'æ–°å¢å¤±æ•—';
  });
}
</script>
<script>
(function(){
  const form = document.querySelector('#preferences-form');
  if (!form) return;
  const themeSel = form.querySelector('select[name="theme"]');
  const msg = document.getElementById('pref-msg');

  function applyTheme(theme){
    document.documentElement.setAttribute('data-bs-theme', theme === 'dark' ? 'dark' : 'light');
  }
  function persistClient(theme){
    try { localStorage.setItem('fixlog_prefs', JSON.stringify({theme})); } catch {}
    try { document.cookie = `fixlog_theme=${theme}; Path=/; Max-Age=${7*24*3600}`; } catch {}
  }

  async function loadPrefs(){
    try {
      const r = await fetch('{{ url_for("settings.api_get_preferences") }}');
      const j = await r.json();
      const theme = (j && j.ok && j.prefs && j.prefs.theme) ? j.prefs.theme : 'light';
      if (themeSel) themeSel.value = theme;
      applyTheme(theme);
      persistClient(theme);
    } catch(e){}
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const theme = themeSel.value;
    const r = await fetch('{{ url_for("settings.save_preferences") }}', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ theme })
    });
    const j = await r.json().catch(()=>({}));
    if (j && (j.success || j.ok)) {
      // settings.html é‡Œä¿å­˜æˆåŠŸåï¼š
      applyTheme(theme);                                     // å½“é¡µç«‹åˆ»æ¢
      localStorage.setItem('fixlog_prefs', JSON.stringify({theme}));
      document.cookie = `fixlog_theme=${theme}; Path=/; Max-Age=${7*24*3600}`;
      // é€šçŸ¥å…¶å®ƒå·²å¼€çš„åˆ†é¡µï¼ˆç›‘å¬ storage äº‹ä»¶ï¼‰
      localStorage.setItem('fixlog_theme_now', theme);
    } else {
      alert('å„²å­˜å¤±æ•—');
    }
  });

  themeSel?.addEventListener('change', ()=> applyTheme(themeSel.value));
  document.addEventListener('DOMContentLoaded', loadPrefs);
})();
</script>
{% endblock %}