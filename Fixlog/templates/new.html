{% extends "_layout.html" %}

{% block page_actions %}
  <form method="POST" id="repair-form" class="mb-0 d-flex align-items-center">
    <button type="button" class="btn btn-outline-secondary btn-sm me-2" id="btn-save-draft">儲存草稿</button>
    <button type="submit" class="btn btn-success btn-sm" id="btn-publish" onclick="prepareSubmission(event)">發布</button>
    <input type="hidden" name="title" id="title">
    <input type="hidden" name="category" id="category">
    <input type="hidden" name="details" id="details">
    <input type="hidden" name="date" id="date">
    <input type="hidden" name="status" value="已建立">
    <input type="hidden" name="summary" value="系統自動產生摘要">
  </form>
{% endblock %}

{% block content %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<div class="editor-container container py-4" style="max-width:1000px;">
  <!-- 標題 -->
  <input type="text" class="custom-title form-control-plaintext fs-2 fw-bold mb-3" placeholder="請輸入標題…">

  <!-- 主分類 / 子分類（主分類半寬，選到工具時顯示右側子分類） -->
  <div class="row g-2 mb-3">
    <div class="col-12 col-md-6">
      <select id="main-category" class="form-select" required onchange="handleCategoryChange(this.value)">
        <option value="">請選擇分類</option>
        <option value="Notes">🗒️ Notes</option>
        <option value="Office">🧾 Office</option>
        <option value="ERP">💼 ERP</option>
        <option value="Printer">🖨️ 印表機</option>
        <option value="Network">🌐 網路相關</option>
        <option value="tools">🔧 維修工具</option>
      </select>
    </div>
    <div class="col-12 col-md-6 d-none" id="tool-subcategory-wrap">
      <select id="tool-subcategory" class="form-select"
              onchange="document.querySelector('#category').value = this.value">
        <option value="">請選擇分類</option>
        <option value="tools_outlook">Outlook工具</option>
        <option value="tools_notes">Notes工具</option>
        <option value="tools_aspen">ASPEN工具</option>
        <option value="tools_tim">TIM工具</option>
        <option value="tools_erp">ERP工具</option>
        <option value="tools_nav">防毒工具</option>
        <option value="tools_system">系統工具</option>
        <option value="tools_other">其他工具</option>
      </select>
    </div>
  </div>

  <!-- 編輯器 -->
  <div id="editor" style="height:600px;background:#fff;"></div>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
  /* ===== Quill 初始化 ===== */
  const quill = new Quill('#editor', {
    theme: 'snow',
    placeholder: '開始撰寫教學內容...',
    modules: {
      toolbar: [
        [{ header: [1, 2, 3, false] }],
        ['bold', 'italic', 'underline'],
        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
        ['link', 'image']
      ]
    }
  });

  /* ===== 圖片上傳：把 dataURL 轉為 URL（避免 413） ===== */
  async function uploadImage(file) {
    if (!file) return null;
    const fd = new FormData(); fd.append('file', file);
    const res = await fetch('/upload', { method:'POST', body:fd });
    if (!res.ok) return null;
    try { const j = await res.json(); return j && j.url; } catch { return null; }
  }
  async function replaceDataUrlsWithUploads() {
    const imgs = Array.from(quill.root.querySelectorAll('img[src^="data:"]'));
    for (const img of imgs) {
      try {
        const blob = await (await fetch(img.src)).blob();
        const ext = (blob.type && blob.type.split('/')[1]) || 'png';
        const file = new File([blob], 'paste.' + ext, { type: blob.type || 'image/png' });
        const url = await uploadImage(file);
        if (url) img.setAttribute('src', url);
      } catch {}
    }
  }

  /* ===== 送出（發布） ===== */
  async function prepareSubmission(e) {
    e.preventDefault();
    await replaceDataUrlsWithUploads();
    document.querySelector('#title').value = document.querySelector('.custom-title').value || '';
    document.querySelector('#details').value = quill.root.innerHTML;

    const now = new Date();
    const formatted = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' +
                      String(now.getDate()).padStart(2,'0') + ' ' + String(now.getHours()).padStart(2,'0') +
                      ':' + String(now.getMinutes()).padStart(2,'0');
    document.querySelector('#date').value = formatted;

    document.getElementById('repair-form').submit();
  }

  /* ===== 儲存草稿 ===== */
  async function saveDraft() {
    await replaceDataUrlsWithUploads();
    const draft = {
      title: document.querySelector('.custom-title').value,
      category: document.querySelector('#category').value,
      details: quill.root.innerHTML
    };
    fetch('/save_draft', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(draft)
    });
    alert('草稿已儲存');
  }
  document.getElementById('btn-save-draft').addEventListener('click', saveDraft);

  /* ===== 分類切換 ===== */
  function handleCategoryChange(value) {
    const hiddenCat = document.querySelector('#category');
    const toolWrap = document.getElementById('tool-subcategory-wrap');
    if (value === 'tools') {
      toolWrap.classList.remove('d-none');
      const sub = document.getElementById('tool-subcategory').value;
      hiddenCat.value = sub; // 預設同步第一個子分類
    } else {
      toolWrap.classList.add('d-none');
      hiddenCat.value = value || '';
    }
  }
  window.handleCategoryChange = handleCategoryChange;

  /* ===== 影像樣式一致化（保留原邏輯） ===== */
  function normalizeImage(img){
    if (!img) return;
    img.removeAttribute('width'); img.removeAttribute('height');
    img.style.maxWidth='100%'; img.style.height='auto';
    img.style.display='block'; img.style.margin='8px auto'; img.style.objectFit='contain';
  }
  function applyResponsiveImages(root=document){ root.querySelectorAll('.ql-editor img').forEach(normalizeImage); }
  const toolbar = quill.getModule('toolbar');
  if (toolbar) {
    toolbar.addHandler('image', () => {
      const input = document.createElement('input');
      input.type='file'; input.accept='image/*';
      input.onchange = () => {
        const file = input.files && input.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
          const range = quill.getSelection(true) || { index: quill.getLength(), length: 0 };
          quill.insertEmbed(range.index, 'image', e.target.result, 'user');
          quill.setSelection(range.index + 1, 0);
          requestAnimationFrame(() => applyResponsiveImages());
        };
        reader.readAsDataURL(file);
      };
      input.click();
    });
  }
  quill.root.addEventListener('paste', () => setTimeout(() => applyResponsiveImages(), 0));
  quill.root.addEventListener('drop',  () => setTimeout(() => applyResponsiveImages(), 0));
  const mo = new MutationObserver(muts => {
    for (const m of muts) {
      m.addedNodes && m.addedNodes.forEach(n => {
        if (n.nodeType === 1) {
          if (n.tagName === 'IMG') normalizeImage(n);
          n.querySelectorAll && n.querySelectorAll('img').forEach(normalizeImage);
        }
      });
    }
  });
  mo.observe(quill.root, { childList:true, subtree:true });

  /* ===== 草稿回填（有就還原分類/內容） ===== */
  (async function loadDraft(){
    try{
      const r = await fetch('/load_draft'); const data = await r.json();
      if (data.title) document.querySelector('.custom-title').value = data.title;
      if (data.category) {
        document.querySelector('#category').value = data.category;
        if (data.category.startsWith('tools_')) {
          document.getElementById('main-category').value = 'tools';
          document.getElementById('tool-subcategory-wrap').classList.remove('d-none');
          document.getElementById('tool-subcategory').value = data.category;
        } else {
          document.getElementById('main-category').value = data.category;
          document.getElementById('tool-subcategory-wrap').classList.add('d-none');
        }
      }
      if (data.details) quill.root.innerHTML = data.details;
    }catch(e){}
  })();
</script>
{% endblock %}