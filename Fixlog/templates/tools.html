{% extends "_layout.html" %}

{% block content %}
<div class="container py-5">
  <!-- æ¨™é¡Œ + å³ä¸Šåˆ†é¡ä¸‹æ‹‰ -->
  <div class="d-flex align-items-center justify-content-between mb-4">
    <h1 class="display-5 fw-bold mb-0">ç•°å¸¸è™•ç†å·¥å…·</h1>

    {% set current = request.args.get('sub','all') %}
    <div style="min-width:220px;">
      <select id="tool-filter-select" class="form-select form-select-sm">
        <option value="all"      {{ 'selected' if current=='all' else '' }}>å…¨éƒ¨</option>
        <option value="outlook"  {{ 'selected' if current=='outlook' else '' }}>Outlookå·¥å…·</option>
        <option value="notes"  {{ 'selected' if current=='notes' else '' }}>Noteså·¥å…·</option>
        <option value="aspen"  {{ 'selected' if current=='aspen' else '' }}>ASPENå·¥å…·</option>
        <option value="tim"  {{ 'selected' if current=='tim' else '' }}>TIMå·¥å…·</option>
        <option value="erp"  {{ 'selected' if current=='erp' else '' }}>ERPå·¥å…·</option>
        <option value="nav" {{ 'selected' if current=='nav' else '' }}>é˜²æ¯’å·¥å…·</option>
        <option value="system" {{ 'selected' if current=='system' else '' }}>ç³»çµ±å·¥å…·</option>
        <option value="other"  {{ 'selected' if current=='other' else '' }}>å…¶ä»–å·¥å…·</option>
      </select>
    </div>
  </div>

  {% if tools %}
    <div class="row">
      {% for t in tools %}
        {# data-item-sub ç”¨ä¾†å‰ç«¯ç¯©é¸ï¼›æ²’æœ‰å­åˆ†é¡å°±ç•¶ general #}
        <div class="col-12 col-md-6 mb-4" data-item-sub="{{ t.tool_subcategory or 'general' }}">
          <div class="card h-100 shadow-sm">
            <div class="card-body d-flex flex-column">
              <h3 class="card-title">
                <a href="{{ url_for('tool_detail', tool_id=t.id) }}" class="text-decoration-none">{{ t.title }}</a>
              </h3>

              <p class="text-muted mb-1">
                ğŸ“… {{ t.date }} | ğŸ‘¤ {{ t.author }}
                {% if t.tool_subcategory %}
                  | <span class="badge bg-secondary">{{ t.tool_subcategory }}</span>
                {% endif %}
              </p>
              <p class="text-muted mb-3">ğŸ‘ï¸ {{ t.views }} æ¬¡ç€è¦½</p>

              <div class="mt-auto">
                <a href="{{ url_for('tool_detail', tool_id=t.id) }}" class="btn btn-sm btn-outline-primary">é–±è®€æ›´å¤š</a>
                {% if session.get('username') == 'admin' %}
                  <form method="POST" action="{{ url_for('delete_tool', tool_id=t.id) }}" class="d-inline"
                        onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†å·¥å…·ç´€éŒ„å—ï¼Ÿ');">
                    <button type="submit" class="btn btn-sm btn-outline-danger">åˆªé™¤</button>
                  </form>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info text-center">ğŸš« ç›®å‰å°šç„¡ç¶­ä¿®å·¥å…·ç´€éŒ„ã€‚</div>
  {% endif %}
</div>

<!-- ä¸‹æ‹‰å¼é¸å–®å‰ç«¯ç¯©é¸ï¼ˆæ”¯æ´ç¶²å€åƒæ•¸ ?sub=xxxï¼‰ -->
<script>
(function(){
  const select = document.getElementById('tool-filter-select');
  const cards  = document.querySelectorAll('[data-item-sub]');

  function applyFilter(val){
    const target = (val || 'all').toLowerCase();
    cards.forEach(col=>{
      const sub = (col.dataset.itemSub || 'general').toLowerCase();
      col.classList.toggle('d-none', target !== 'all' && sub !== target);
    });
    // æ›´æ–°ç¶²å€åƒæ•¸ï¼ˆåˆ†äº«/é‡æ–°æ•´ç†å¯ä¿ç•™ï¼‰
    const u = new URL(location.href);
    if (target === 'all') u.searchParams.delete('sub'); else u.searchParams.set('sub', target);
    history.replaceState(null, '', u.toString());
  }

  // åˆå§‹ï¼šè®€å– ?sub= åƒæ•¸å¥—ç”¨
  const init = new URL(location.href).searchParams.get('sub') || select.value || 'all';
  select.value = init;
  applyFilter(init);

  // è®Šæ›´ï¼šå³æ™‚ç¯©é¸
  select.addEventListener('change', e => applyFilter(e.target.value));
})();
</script>

<script>
(function(){
  try{
    if (sessionStorage.getItem("entryFadeOnce") !== "1") return;
    sessionStorage.removeItem("entryFadeOnce");

    // å»ºç«‹èˆ‡ç™»å…¥é åŒè‰²èª¿çš„è¦†è“‹å±¤
    const ovl = document.createElement("div");
    ovl.style.cssText = `
      position:fixed; inset:0; z-index:9999; pointer-events:none;
      background: linear-gradient(to bottom, #2e026d, #6d28d9 45%, #a78bfa 90%);
      opacity:1;
      transition: opacity .45s ease, filter .45s ease;
      filter: brightness(1.02) saturate(1.04);
    `;
    document.body.appendChild(ovl);

    // ç­‰ä¸€å€‹ frame ç¢ºä¿æ¸²æŸ“ï¼Œå†æ·¡å‡º
    requestAnimationFrame(()=>{ 
      ovl.style.opacity = "0"; 
      ovl.style.filter = "none";
    });

    // å®Œå…¨é€æ˜å¾Œç§»é™¤
    ovl.addEventListener("transitionend", ()=> ovl.remove(), { once:true });
  }catch(e){}
})();
</script>
{% endblock %}