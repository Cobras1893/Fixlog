<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="FixLog ç³»çµ± - æ•…éšœç´€éŒ„èˆ‡æ•™å­¸å¹³å°">
  <meta name="author" content="FixLog Team">
  <title>ç•°å¸¸ç¶­ä¿®ç´€éŒ„</title>
  <link rel="icon" href="/static/img/favicon.ico">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <style>
    body {
      background-color: #fff;
      font-family: 'Georgia', serif;
    }
    .editor-container {
      max-width: 1000px;
      margin: 60px auto;
      padding: 20px 16px;
    }
    .custom-title {
      font-size: 2.5rem;
      font-weight: bold;
      border: none;
      outline: none;
      width: 100%;
      margin-bottom: 20px;
    }
    #editor {
      height: 600px;
      background-color: white;
    }
    .navbar {
      background-color: #fff;
      border-bottom: 1px solid #dee2e6;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
      padding: 0.5rem 1rem;
    }
    .navbar .navbar-brand {
      font-size: 1.6rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .navbar .navbar-brand span {
      font-weight: 600;
    }
    .navbar .btn-outline-secondary,
    .navbar .btn-success {
      font-size: 0.875rem;
    }
    #sidebar {
      width: 240px;
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      background-color: white;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 1000;
    }
    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.3);
      display: none;
      z-index: 999;
    }
    .sidebar-content {
      padding-top: 80px;
      text-align: center;
    }
    .sidebar-content ul li a {
      display: block;
      padding: 12px;
      font-size: 1rem;
    }
    .hamburger-btn {
      width: 24px;
      height: 24px;
      background: none;
      border: none;
      cursor: pointer;
      position: relative;
      z-index: 1050;
    }
    .hamburger-line {
      position: absolute;
      width: 100%;
      height: 3px;
      background-color: #333;
      border-radius: 2px;
      transition: all 0.3s ease;
      left: 0;
    }
    .hamburger-line.top { top: 4px; }
    .hamburger-line.middle { top: 10px; }
    .hamburger-line.bottom { top: 16px; }
    .hamburger-btn:hover .hamburger-line {
      transform: scaleX(1.2);
      background-color: #007bff;
    }
    #menu-close {
      position: absolute;
      top: 16px;
      left: 16px;
      font-size: 1.5rem;
      background: none;
      border: none;
      cursor: pointer;
      z-index: 1050;
    }
    .hidden {
      display: none !important;
    }
  </style>
  <style>
    /* Quill ç¼–è¾‘å™¨ä¸­çš„å›¾ç‰‡ï¼šç­‰æ¯”ç¼©æ”¾ä¸”ä¸è¶…å‡ºå†…å®¹å®½åº¦ */
    .ql-editor img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 8px auto;         /* ç½®ä¸­ + ç•™ç‚¹é—´è· */
      object-fit: contain;      /* é¿å…æ‹‰ä¼¸ */
    }
    /* é¢„é˜²ä¸»é¢˜é‡ŒæŸäº› reset ç»™ img å†™äº†å›ºå®šå®½é«˜ */
    .ql-editor img[width], .ql-editor img[height] {
      width: auto !important;
      height: auto !important;
    }
  </style>
  <style>
    .ql-editor img {
      max-width: 100% !important;   /* è¦†ç›–è¡Œå†… style/width */
      height: auto !important;
      display: block;
      margin: 8px auto;
      object-fit: contain;
    }
    .ql-editor img[width], .ql-editor img[height] {
      width: auto !important;
      height: auto !important;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-light bg-white border-bottom shadow-sm px-3 py-2">
    <div class="container-fluid d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-3">
        <button id="menu-toggle" class="hamburger-btn me-3" aria-label="Open menu">
          <span class="hamburger-line top"></span>
          <span class="hamburger-line middle"></span>
          <span class="hamburger-line bottom"></span>
        </button>
        <a class="navbar-brand fw-bold d-flex align-items-center mb-0" href="/" style="font-size: 1.6rem;">
          ğŸ› ï¸ <span class="ms-2">FixLog</span>
        </a>
      </div>
      <div class="d-flex align-items-center gap-3">
        <form method="POST" id="repair-form">
          <button type="submit" class="btn btn-success btn-sm" onclick="prepareSubmission(event)">ç™¼å¸ƒ</button>
          <input type="hidden" name="title" id="title">
          <input type="hidden" name="category" id="category">
          <input type="hidden" name="details" id="details">
          <input type="hidden" name="date" id="date">
          <input type="hidden" name="status" value="å·²å»ºç«‹">
          <input type="hidden" name="summary" value="ç³»çµ±è‡ªå‹•ç”¢ç”Ÿæ‘˜è¦">
        </form>
        <span class="text-muted small">ğŸ‘¤ {{ username }}{% if role %}ï¼ˆ{{ role }}ï¼‰{% endif %}</span>
        <a href="/logout" class="btn btn-sm btn-outline-secondary">ç™»å‡º</a>
      </div>
    </div>
  </nav>

  <div id="sidebar">
    <button id="menu-close" aria-label="Close">âœ•</button>
    <div class="sidebar-content">
      <div class="fw-bold mb-3">ğŸ“ åˆ†é¡é¸å–®</div>
      <ul class="list-unstyled">
        <li><a href="/new" class="text-dark text-decoration-none">â• æ–°å¢ç•°å¸¸</a></li>
        <li><a href="/tools" class="text-dark text-decoration-none">ğŸ§° ç¶­ä¿®å·¥å…·</a></li>
        <li><a href="/settings" class="text-dark text-decoration-none">âš™ï¸ ç³»çµ±è¨­å®š</a></li>
      </ul>
    </div>
  </div>
  <div id="overlay"></div>

  <div class="editor-container">
    <input type="text" class="custom-title" placeholder="è«‹è¼¸å…¥æ¨™é¡Œ..." required oninput="document.querySelector('#title').value = this.value">
    <select class="form-select mb-3" required onchange="document.querySelector('#category').value = this.value">
      <option value="">è«‹é¸æ“‡åˆ†é¡</option>
      <option value="Notes">ğŸ—’ï¸ Notes</option>
      <option value="Office">ğŸ§¾ Office</option>
      <option value="ERP">ğŸ’¼ ERP</option>
      <option value="Printer">ğŸ–¨ï¸ å°è¡¨æ©Ÿ</option>
      <option value="Network">ğŸŒ ç¶²è·¯ç›¸é—œ</option>
      <option value="tools">ğŸ”§ ç¶­ä¿®å·¥å…·</option>
    </select>
    <div id="toolbar-container"></div>
    <div id="editor"></div>
  </div>

  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script>
    const quill = new Quill('#editor', {
      theme: 'snow',
      placeholder: 'é–‹å§‹æ’°å¯«æ•™å­¸å…§å®¹...',
      modules: {
        toolbar: [
          [{ header: [1, 2, 3, false] }],
          ['bold', 'italic', 'underline'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          ['link', 'image']
        ]
      }
    });

    function prepareSubmission(e) {
      e.preventDefault();
      document.querySelector('#details').value = quill.root.innerHTML;
      const now = new Date();
      const formatted = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' +
                        String(now.getDate()).padStart(2, '0') + ' ' + String(now.getHours()).padStart(2, '0') +
                        ':' + String(now.getMinutes()).padStart(2, '0');
      document.querySelector('#date').value = formatted;
      document.getElementById('repair-form').submit();
    }

    const menuToggle = document.getElementById('menu-toggle');
    const menuClose = document.getElementById('menu-close');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');

    function openMenu() {
      sidebar.style.transform = 'translateX(0)';
      overlay.style.display = 'block';
      menuToggle.classList.add('hidden');
    }

    function closeMenu() {
      sidebar.style.transform = 'translateX(-100%)';
      overlay.style.display = 'none';
      menuToggle.classList.remove('hidden');
    }

    menuToggle.onclick = openMenu;
    menuClose.onclick = closeMenu;
    overlay.onclick = closeMenu;

    // å„²å­˜è‰ç¨¿
    function saveDraft() {
      const draft = {
        title: document.querySelector('.custom-title').value,
        category: document.querySelector('#category').value,
        details: quill.root.innerHTML
      };
      fetch('/save_draft', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(draft)
      });
      alert('è‰ç¨¿å·²å„²å­˜');
    }

    // è¼‰å…¥è‰ç¨¿
    async function loadDraft() {
      const res = await fetch('/load_draft');
      const data = await res.json();
      if (data.title) document.querySelector('.custom-title').value = data.title;
      if (data.category) {
        document.querySelector('#category').value = data.category;
        document.querySelector('select.form-select').value = data.category;
      }
      if (data.details) quill.root.innerHTML = data.details;
    }

    // åŠ ä¸Šè‰ç¨¿æŒ‰éˆ•
    const publishBtn = document.querySelector('form button[type="submit"]');
    const draftBtn = document.createElement('button');
    draftBtn.textContent = 'å„²å­˜è‰ç¨¿';
    draftBtn.type = 'button';
    draftBtn.className = 'btn btn-outline-secondary btn-sm me-2';
    draftBtn.onclick = saveDraft;
    publishBtn.parentNode.insertBefore(draftBtn, publishBtn);


  </script>

  <script>
  // â€”â€” ç»Ÿä¸€ç»™å›¾ç‰‡åŠ å“åº”å¼æ ·å¼ + æ¸…ç†è¡Œå†…å°ºå¯¸ â€”â€” //
  function normalizeImage(img){
    if (!img) return;
    img.removeAttribute('width');
    img.removeAttribute('height');
    img.style.width = '';
    img.style.height = '';
    img.style.maxWidth = '100%';
    img.style.height   = 'auto';
    img.style.display  = 'block';
    img.style.margin   = '8px auto';
    img.style.objectFit = 'contain';
  }
  function applyResponsiveImages(root = document) {
    root.querySelectorAll('.ql-editor img').forEach(normalizeImage);
  }

  // â‘  è¦†å†™å·¥å…·åˆ—çš„ã€Œå›¾ç‰‡ã€æŒ‰é’®ï¼ˆæœ¬åœ°é€‰æ‹©ï¼‰
  const toolbar = quill.getModule('toolbar');
  if (toolbar) {
    toolbar.addHandler('image', () => {
      const input = document.createElement('input');
      input.type = 'file'; input.accept = 'image/*';
      input.onchange = () => {
        const file = input.files && input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
          const range = quill.getSelection(true) || { index: quill.getLength(), length: 0 };
          quill.insertEmbed(range.index, 'image', e.target.result, 'user');
          quill.setSelection(range.index + 1, 0);
          requestAnimationFrame(() => applyResponsiveImages());
        };
        reader.readAsDataURL(file);
      };
      input.click();
    });
  }

  // â‘¡ å¤„ç†ã€Œè´´ä¸Š / æ‹–æ”¾ã€çš„å›¾ç‰‡ï¼ˆå¼‚æ­¥æ’å…¥ï¼Œå»¶è¿Ÿæ¸…ç†ï¼‰
  quill.root.addEventListener('paste', () => setTimeout(() => applyResponsiveImages(), 0));
  quill.root.addEventListener('drop',  () => setTimeout(() => applyResponsiveImages(), 0));

  // â‘¢ ç›‘å¬ç¼–è¾‘å™¨å†…å®¹å˜åŒ–ï¼šä¸€æ—¦å‡ºç° <img> å°±ç«‹å³è§„èŒƒå°ºå¯¸
  const mo = new MutationObserver(muts => {
    for (const m of muts) {
      m.addedNodes && m.addedNodes.forEach(n => {
        if (n.nodeType === 1) {
          if (n.tagName === 'IMG') normalizeImage(n);
          n.querySelectorAll && n.querySelectorAll('img').forEach(normalizeImage);
        }
      });
    }
  });
  mo.observe(quill.root, { childList: true, subtree: true });

  // â‘£ é¦–æ¬¡è½½å…¥è‰ç¨¿ï¼ˆæˆ–åˆ·æ–°ï¼‰åï¼Œè·‘ä¸€æ¬¡å…œåº•
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => applyResponsiveImages(), 0);
  });
  </script>

  <script>
  (function () {
    // å–å¾— URL å‚æ•°
    function getParam(name){
      const u = new URL(location.href);
      return u.searchParams.get(name) || '';
    }

    // ç­‰å¾… Quill å®ä¾‹å‡†å¤‡å¥½
    function waitForEditor(maxWaitMs = 3000) {
      return new Promise((resolve) => {
        const start = performance.now();
        (function loop(){
          // å¸¸è§å…¨å±€å˜é‡åå°è¯•
          const quillInst = window.quill || window.editor || window.quillEditor;
          // æˆ–è€…ç›´æ¥æŠ“ .ql-editor
          const qlEditor = document.querySelector('.ql-editor');
          if (quillInst || qlEditor) return resolve({ quillInst, qlEditor });
          if (performance.now() - start > maxWaitMs) return resolve({ quillInst: null, qlEditor: null });
          requestAnimationFrame(loop);
        })();
      });
    }

    async function fetchDraftByIdOrLatest() {
      const did = getParam('draft_id');
      const url = did ? `/load_draft?id=${encodeURIComponent(did)}` : '/load_draft';
      const r = await fetch(url);
      if (!r.ok) return {};
      return await r.json().catch(() => ({}));
    }

    function syncBasicFields(data) {
      const titleVisible = document.querySelector('.custom-title');
      const titleHidden  = document.querySelector('#title');
      const catSelectUI  = document.querySelector('select.form-select'); // ä½ çš„å¯è§åˆ†ç±»ä¸‹æ‹‰ï¼ˆè‹¥æœ‰å…¶ä»– selectorï¼Œè¯·æ›¿æ¢ï¼‰
      const catHidden    = document.querySelector('#category');          // éšè—æ ä½ï¼ˆè‹¥æ²¡æœ‰å¯å¿½ç•¥ï¼‰

      if (data.title != null) {
        if (titleVisible) titleVisible.value = data.title || '';
        if (titleHidden)  titleHidden.value  = data.title || '';
      }
      if (data.category != null) {
        if (catHidden)   catHidden.value = data.category || '';
        if (catSelectUI) catSelectUI.value = data.category || '';
      }
    }

    function setEditorContent(editors, html) {
      const { quillInst, qlEditor } = editors;
      if (typeof html !== 'string') html = '';

      // 1) æœ‰ Quill å®ä¾‹ï¼šç”¨ dangerouslyPasteHTML æœ€ç¨³
      if (quillInst && quillInst.clipboard && typeof quillInst.clipboard.dangerouslyPasteHTML === 'function') {
        quillInst.clipboard.dangerouslyPasteHTML(html);
        return;
      }

      // 2) é€€è·¯ï¼šç›´æ¥å†™å…¥ç¼–è¾‘å™¨ DOM
      if (qlEditor) {
        qlEditor.innerHTML = html;
        return;
      }

      // 3) å…œåº•ï¼šè‹¥ä½ åŒæ—¶æœ‰éšè— textarea[name="details"]ï¼Œä¹Ÿä¸€å¹¶å†™å…¥ï¼ˆä»¥é˜²æäº¤ï¼‰
      const ta = document.querySelector('textarea[name="details"], #details');
      if (ta) ta.value = html;
    }

    window.addEventListener('DOMContentLoaded', async () => {
      // å…ˆæ‹¿æ•°æ®
      const data = await fetchDraftByIdOrLatest();
      // å†ç­‰ç¼–è¾‘å™¨ ready
      const editors = await waitForEditor();

      // åŒæ­¥æ ‡é¢˜/åˆ†ç±»
      syncBasicFields(data);

      // å†™å…¥å†…å®¹ï¼ˆdetailsï¼‰
      setEditorContent(editors, data.details);

      // åŒæ­¥éšè— textareaï¼Œé˜²æ­¢ä»…ç¼–è¾‘å™¨æ˜¾ç¤ºè€Œæäº¤ä¸ºç©º
      const ta = document.querySelector('textarea[name="details"], #details');
      if (ta && typeof data.details === 'string') ta.value = data.details;
    });
  })();
  </script>
</body>
</html>
